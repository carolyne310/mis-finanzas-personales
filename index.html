<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ================= SEO ================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aura - Finanzas personales modernas, simples y seguras." />
  <title>Aura ¬∑ Finanzas Personales</title>

  <!-- ================= FUENTE ================= -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
    rel="stylesheet"
  >

  <!-- ================= TAILWIND CDN ================= -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            jakarta: ['"Plus Jakarta Sans"', 'sans-serif']
          },
          borderRadius: {
            xl2: '2.5rem'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-50 font-jakarta text-slate-900">
  <div id="root"></div>

  <!-- ================= REACT ================= -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- ================= BABEL (OBLIGATORIO) ================= -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ================= FIREBASE ================= -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ================= APP ================= -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    /* ======================================================
       FIREBASE CONFIG (REEMPLAZA CON EL TUYO)
    ====================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyD2h9l8LDl_R85R6R5Lr961jcoxVCDkSNs",
  authDomain: "mis-finanzas-600dc.firebaseapp.com",
  projectId: "mis-finanzas-600dc",
  storageBucket: "mis-finanzas-600dc.firebasestorage.app",
  messagingSenderId: "509918317471",
  appId: "1:509918317471:web:b7e6c9bfc1892fcf5d4baa"
};

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const APP_ID = "aura";

    /* ======================================================
       UTILIDAD: EXPORTAR CSV
    ====================================================== */
    function exportToCSV(transactions) {
      const headers = ["Monto", "Tipo", "Categor√≠a", "Nota", "Fecha"];
      const rows = transactions.map(t => [
        t.amount,
        t.type,
        t.category,
        t.note || "",
        new Date(t.createdAt).toLocaleString()
      ]);

      let csv =
        "data:text/csv;charset=utf-8," +
        headers.join(",") +
        "\n" +
        rows.map(r => r.join(",")).join("\n");

      const link = document.createElement("a");
      link.href = encodeURI(csv);
      link.download = "aura-transacciones.csv";
      link.click();
    }

    /* ======================================================
       AUTH SCREEN
    ====================================================== */
    function AuthScreen() {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");

      async function handleSubmit() {
        setError("");
        try {
          if (isLogin) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
          }
        } catch (err) {
          setError(err.message);
        }
      }

      async function loginWithGoogle() {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (err) {
          setError(err.message);
        }
      }

      return (
        <div className="min-h-screen flex items-center justify-center px-6">
          <div className="bg-white w-full max-w-sm p-8 rounded-xl2 shadow-xl">
            <h1 className="text-3xl font-bold text-indigo-700 text-center mb-2">
              Aura
            </h1>
            <p className="text-center text-slate-500 mb-6">
              Finanzas personales, sin estr√©s
            </p>

            <input
              className="w-full mb-3 p-3 rounded-xl border"
              placeholder="Correo electr√≥nico"
              value={email}
              onChange={e => setEmail(e.target.value)}
            />

            <input
              type="password"
              className="w-full mb-3 p-3 rounded-xl border"
              placeholder="Contrase√±a"
              value={password}
              onChange={e => setPassword(e.target.value)}
            />

            {error && (
              <p className="text-red-500 text-sm mb-2">{error}</p>
            )}

            <button
              className="w-full bg-indigo-700 text-white py-3 rounded-xl mb-3"
              onClick={handleSubmit}
            >
              {isLogin ? "Iniciar Sesi√≥n" : "Registrarse"}
            </button>

            <button
              className="w-full border py-3 rounded-xl mb-3"
              onClick={loginWithGoogle}
            >
              Ingresar con Google
            </button>

            <p className="text-center text-sm text-slate-500">
              {isLogin ? "¬øNo tienes cuenta?" : "¬øYa tienes cuenta?"}
              <span
                className="text-indigo-700 ml-1 cursor-pointer"
                onClick={() => setIsLogin(!isLogin)}
              >
                {isLogin ? "Reg√≠strate" : "Inicia sesi√≥n"}
              </span>
            </p>
          </div>
        </div>
      );
    }

    /* ======================================================
       APP PRINCIPAL
    ====================================================== */
    function App() {
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);

  const [showModal, setShowModal] = useState(false);
  const [amount, setAmount] = useState("");
  const [type, setType] = useState("gasto");
  const [category, setCategory] = useState("");
  const [note, setNote] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  // üîê Auth listener
  useEffect(() => {
    return auth.onAuthStateChanged(u => setUser(u));
  }, []);

  // üî• Firestore realtime listener (AQU√ç estaba el error)
  useEffect(() => {
    if (!user) return;

    const unsubscribe = db
      .collection("artifacts")
      .doc(APP_ID)
      .collection("users")
      .doc(user.uid)
      .collection("transactions")
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        const data = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setTransactions(data);
      });

    // cleanup correcto
    return unsubscribe;
  }, [user]);

  // ‚ûï Agregar transacci√≥n
  async function addTransaction() {
    if (!amount || !category) {
  setError("Completa el monto y la categor√≠a");
  return;
}

    setLoading(true);

    try {
      await db
        .collection("artifacts")
        .doc(APP_ID)
        .collection("users")
        .doc(user.uid)
        .collection("transactions")
        .add({
          amount: Number(amount),
          type,
          category,
          note,
          createdAt: Date.now()
        });

      setError("");
      setAmount("");
      setCategory("");
      setNote("");
      setType("gasto");
      setShowModal(false);
    } catch (err) {
      alert("Error al guardar la transacci√≥n");
    }

    setLoading(false);
  }

  // ‚õî Guard clause
  if (!user) return <AuthScreen />;

  const balance = transactions.reduce((acc, t) => {
    if (t.type === "ingreso") return acc + t.amount;
    if (t.type === "gasto") return acc - t.amount;
    return acc;
  }, 0);

  return (
    <div className="pb-28">
          {/* HEADER */}
          <div className="bg-indigo-700 text-white p-6 rounded-b-xl2">
            <p className="text-sm opacity-80">Balance Total</p>
            <h2 className="text-3xl font-bold">
              S/ {balance.toFixed(2)}
            </h2>
          </div>

          {/* CONTENIDO */}
          <div className="p-4">
            <button
              className="mb-4 bg-emerald-500 text-white px-4 py-2 rounded-xl"
              onClick={() => exportToCSV(transactions)}
            >
              Exportar CSV
            </button>

            {transactions.length === 0 && (
              <p className="text-slate-500 text-center mt-6">
                A√∫n no tienes transacciones
              </p>
            )}

            {transactions.map(t => (
              <div
                key={t.id}
                className="bg-white p-4 mb-3 rounded-xl shadow flex justify-between items-center"
              >
                <div>
                  <p className="font-semibold">
                    {t.type === "ingreso" ? "üí∞" : "üí∏"} {t.category}
                  </p>
                  <p className="text-sm text-slate-500">
                    {t.note}
                  </p>
                </div>
                <p
                  className={
                    t.type === "ingreso"
                      ? "text-emerald-600 font-semibold"
                      : "text-rose-500 font-semibold"
                  }
                >
                  S/ {t.amount}
                </p>
              </div>
            ))}
          </div>
<button
  onClick={() => setShowModal(true)}
  className="fixed bottom-24 right-6 bg-indigo-700 text-white w-14 h-14 rounded-full text-3xl flex items-center justify-center shadow-xl"
>
  +
</button>
         {showModal && (
  <div className="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-end justify-center z-50">
    <div className="bg-white w-full max-w-md p-6 rounded-t-[2.5rem]">
      <h3 className="text-xl font-bold mb-4">Nueva transacci√≥n</h3>

      <form
        onSubmit={(e) => {
          e.preventDefault();
          addTransaction();
        }}
      >
        {/* MONTO */}
        <input
          type="number"
          placeholder="Monto (S/)"
          className="w-full p-3 mb-3 rounded-xl border"
          value={amount}
          onChange={e => setAmount(e.target.value)}
        />

        {/* TIPO */}
        <div className="flex gap-2 mb-3">
          {["ingreso", "gasto", "ahorro"].map(t => (
            <button
              key={t}
              type="button"   // üëà IMPORTANTE
              onClick={() => setType(t)}
              className={`flex-1 py-2 rounded-xl border ${
                type === t
                  ? t === "ingreso"
                    ? "bg-emerald-500 text-white"
                    : t === "gasto"
                    ? "bg-rose-500 text-white"
                    : "bg-violet-500 text-white"
                  : "bg-white"
              }`}
            >
              {t === "ingreso"
                ? "üí∞ Ingreso"
                : t === "gasto"
                ? "üí∏ Gasto"
                : "üíú Ahorro"}
            </button>
          ))}
        </div>

        {/* CATEGOR√çA */}
        <input
          placeholder="Categor√≠a (Ej: Comida)"
          className="w-full p-3 mb-3 rounded-xl border"
          value={category}
          onChange={e => setCategory(e.target.value)}
        />

        {/* NOTA */}
        <input
          placeholder="Nota (opcional)"
          className="w-full p-3 mb-4 rounded-xl border"
          value={note}
          onChange={e => setNote(e.target.value)}
        />
{/* üëá AQU√ç VA EL MENSAJE DE ERROR */}
{error && (
  <p className="text-sm text-rose-500 mb-3">
    {error}
  </p>
)}
        {/* ACCIONES */}
        <div className="flex gap-3">
          <button
            type="button"
            className="flex-1 py-3 rounded-xl border"
            onClick={() => setShowModal(false)}
          >
            Cancelar
          </button>

          <button
  type="submit"
  disabled={loading || !amount || !category}
  className={`flex-1 py-3 rounded-xl text-white transition ${
    loading || !amount || !category
      ? "bg-indigo-300 cursor-not-allowed"
      : "bg-indigo-700"
  }`}
>
  {loading ? "Guardando..." : "Guardar"}
</button>
        </div>
      </form>
    </div>
  </div>
)}
          {/* NAV BAR */}
          <div className="fixed bottom-4 left-4 right-4 bg-white/70 backdrop-blur-xl rounded-xl2 shadow-lg flex justify-around py-3">
            <button>üè†</button>
            <button>üìä</button>
            <button>üéØ</button>
            <button onClick={() => auth.signOut()}>üö™</button>
          </div>
        </div>
      );
    }

    ReactDOM
      .createRoot(document.getElementById("root"))
      .render(<App />);
  </script>
</body>
</html>
